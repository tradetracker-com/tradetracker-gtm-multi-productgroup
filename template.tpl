___INFO___

{
  "displayName": "TradeTracker.com MPG",
  "description": "TradeTracker.com Sales and Leads Tracking Tag. \n\nThis tag will allow you to generate sale (transactions) events or custom lead events that will be tracked on your TradeTracker.com campaign.",
  "categories": [
    "AFFILIATE_MARKETING",
    "MARKETING",
    "ATTRIBUTION"
  ],
  "securityGroups": [],
  "id": "cvt_temp_public_id",
  "type": "TAG",
  "version": 1,
  "brand": {
    "thumbnail": "data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAEAAAABACAIAAAAlC+aJAAAAGXRFWHRTb2Z0d2FyZQBBZG9iZSBJbWFnZVJlYWR5ccllPAAAAyhpVFh0WE1MOmNvbS5hZG9iZS54bXAAAAAAADw/eHBhY2tldCBiZWdpbj0i77u/IiBpZD0iVzVNME1wQ2VoaUh6cmVTek5UY3prYzlkIj8+IDx4OnhtcG1ldGEgeG1sbnM6eD0iYWRvYmU6bnM6bWV0YS8iIHg6eG1wdGs9IkFkb2JlIFhNUCBDb3JlIDUuNi1jMTQ1IDc5LjE2MzQ5OSwgMjAxOC8wOC8xMy0xNjo0MDoyMiAgICAgICAgIj4gPHJkZjpSREYgeG1sbnM6cmRmPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5LzAyLzIyLXJkZi1zeW50YXgtbnMjIj4gPHJkZjpEZXNjcmlwdGlvbiByZGY6YWJvdXQ9IiIgeG1sbnM6eG1wPSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvIiB4bWxuczp4bXBNTT0iaHR0cDovL25zLmFkb2JlLmNvbS94YXAvMS4wL21tLyIgeG1sbnM6c3RSZWY9Imh0dHA6Ly9ucy5hZG9iZS5jb20veGFwLzEuMC9zVHlwZS9SZXNvdXJjZVJlZiMiIHhtcDpDcmVhdG9yVG9vbD0iQWRvYmUgUGhvdG9zaG9wIENDIDIwMTkgKE1hY2ludG9zaCkiIHhtcE1NOkluc3RhbmNlSUQ9InhtcC5paWQ6MEM2NDM5MDNCMUU2MTFFOUE0OUVDN0E1MDdBM0ZEQTEiIHhtcE1NOkRvY3VtZW50SUQ9InhtcC5kaWQ6MEM2NDM5MDRCMUU2MTFFOUE0OUVDN0E1MDdBM0ZEQTEiPiA8eG1wTU06RGVyaXZlZEZyb20gc3RSZWY6aW5zdGFuY2VJRD0ieG1wLmlpZDowQzY0MzkwMUIxRTYxMUU5QTQ5RUM3QTUwN0EzRkRBMSIgc3RSZWY6ZG9jdW1lbnRJRD0ieG1wLmRpZDowQzY0MzkwMkIxRTYxMUU5QTQ5RUM3QTUwN0EzRkRBMSIvPiA8L3JkZjpEZXNjcmlwdGlvbj4gPC9yZGY6UkRGPiA8L3g6eG1wbWV0YT4gPD94cGFja2V0IGVuZD0iciI/PsXF6oQAAAx5SURBVHjazFoJeBNlGk5mJnePNE3aphcppW1aaEuphaJgWRUpLSIsgnJ6AK4rIouIi8uzq6s+yoLi4sLqquviglYUQVQsUEQuoSgttlQopUCvtEmvtLmvyeyXJjTNTI5JWnj2f/Ikk5l//vne/7ve70uYBEEw6A2YeEWpr23TXunQt6lNar3VbLPDeS4LEQlYCVHcTKkgJyliTCyfybh9g0kHgMZo+6626/tLPZ1aS8DJUiFn+lhx8TixgIMGKw1hteAdCkKvYyAIGp+EhEcMF4AVJ/ZVKfdVqUxWe1Ci8Nnogolxs8fHoEhgfYDEhgN7jN/tt9ZWExbz4Hls1GjufaX8hx/FklNCAXCjy7i5/Hp7nzlk/crEvBdmpoB1+Zlj+GKX5u3X7L3dPmegqGD+svB1f/GqEJ8ATjWot1U0gQaGaaPgIetnptwhi/Sy8SZT38bVxoP76KwDShB98DnohBaA8otd//qhlRghP0OYzD/cP6ooQ0Qyd/Wzj5t+OESeLBQh4hhC04d3dzLsHnaLRIvFZYdI5uQFwOmr6jcP3fDv25E8LEnEDedixICLt/SadCabn/ngCRsfSM0f5bYBzVuv6D7Y5paDxRYsXs5/aAk2Ru48Y+/pNh4+oHtvK96pdOshLVOy93smh+MTQHOP8fnPrlhw7y4LEpfkSKakRSVHe5g1LNHUbTxR33u4rttgwX259dsL5XGRjmdbL9V2zbuHcfPRaJIs+t1PsTEZXszMaFCv/53p6HduGVatD1+9wTsAG06sKbvc1mvyuoW/zY+dXxDHwRB/HmnByyo7vqnp9KrAtFj+lgVyJpPRu3qZqeLgTcOQwKai0gSfi+J476olpuNHXBLz+LEn6pAIl1N5SHPggsqr9BE87PV56Usmx/uX3rnNy+9OfPnBMXBAvXpVZQAVwQE7b+LgSeHLb/mTfiAKCTftGAxBoBPjwS/djjF4pDfje8+rvEr/t/kZcqmAvteOT44AwF4xfHauw2KzCxatAGd12jR3emngMCAU8Rc+MfjVfKLCCwDItVTzdTjfrNR4ISfYyJMi4b1QkkLNYWqD9eilHiaXy5+3GL7yaEjvHLzps9zp9fJFMgCwWFiXehvYfVB7P3TkJUfMzJFQzzsfxCuZ69BAajrN1bA0udspVB1kAI0qg7LfTI2VCwrihpMBwG0gkZFOXus0QHZnjc2F4MNkc+mSNhbbu3U5P2pbNdRrxdkSdiCv9T+Az92XJaaer23Vwjsnf9LQGO9/4F1u/2RyeWQA9Uo99Z6ijKjhp2Gvi9QrdfDOys43nztFcx1zpXvmUMNzAVCoyfYTNUDxhw8AygOqFbUPPA4yl/nEEVzZTmcdw+cfDx5zCu4kA+jRkYl+smgEpHcSoUTKRnQPPA6JEhFms+aNjYxANYnhqz2W6nPuiFQ6jwyASveFfNZIFU3UpYwWx+OQCKHj+PDXQKf9YDCfPdn/0trBr+yCu1jZeV7yAHnnkJGSH5KJzxTr/NS9/3cgF3hbM4VvG7U7tvSsmA+KunkLFvniax7h1QULQyw2DyVoDLaRAtBHWcpJSQitO/QBXTMfr2AXTmXfMRkVx9i1GtuVX03HDtk1fR6RfcOrrKwcLwCi+JhK4+EGULaPFAAFpaYThbEGaBmPKQhzVMDO/bZZzaePwcvXOuG/XydY+iQ5wTk/IOCQAMDXbq1FHM4epvQtPY5SAbYc6oeYCDaX5TCbxIEIgUoTxWXl6udW2BqvBMhigjDhS1t4sxf4LCnLznUAzSJdWz41cXZezDABgCbNVjtQIwhH3it6m9VQ9h/dzndxRYsX+fgC/txHwp5ah0pi/RX1dQrdxi8bSNeg+Pjn0iw6bYUASZSwtfTV3lBXq3TXteZum92CMllhHJFEIJNFjU8RTmChHIhCltpqS9VZW9M1QqdlcrjAsVk5EziTpkIB4I8jOT+y4gVRfBZQxaHXgB0BfS/xRshojh5D28mmXRfaD+qtfb7mcFB+rnRGkWxZXG4+Ozc/9MbWztOK/dUqak/h7YWZIdBpk01X3vDOmZbP7ATdhtKE+NLZ8vXhHHGIAHp01pU763A7OaGAf7/xUDow0yAct//ify88pzZ2BE3+WMJFuW/IJVODyPSDR9FhrNJcL9aiUJvAPeg0FZ2jTnVsR+VjIUjvqAqtfR9Wraps/SLE3ihUZE/vuqTWW6nzwjjoyqKkIrnIv0fXd53+qOoZ8FqfsZwTjSEc3G7VmLv8rPNw9qsTE+eG0tytadW+tP+qL14yWsKfMyGmMFXotbrv1jdv/XG+GTdQL2XFFBUkPDgmehKf5eommG366+qqKsW3NcpDVD9BmMiqwl0yYW4ozd19VaqPf1T4uYeFMtNiBZCYoN4Hn4GDezKjCcK+7ezC1v5fyS4Ukblg3F8TI7N8rdalb/qi7uVrvefJfJ4X/8LUA2yUF0p32mtE8jW2PiJPjeFXtu4FOcjtCWnxwpzXMSRAOgcNfF2/+VTTbtL5e1NXlqSvoevEQ8djUxIWFUrpSD8uIQykB5uuaHyPdGlszLTFuZsDSu80mDmZGyYnkZkCQDJY+0MB4HCjidI/zUoN4waInveNdYTtus5jfSaP6jaSG7sodxNIRj+ezM16MT7co7towY3nFQdCBABj0ujIHUsyp/mOPMBuCmSOhtmF9nLSpdKMtVwsLMiygTUnawPpZFX7t6EDcBZTa++XbV0ovzs9CnyXGpRARWDBjb0/eTTzODF50pkh5IFUUQHJ3RX9l/1bEa38CoKuK04BVvzzDU11c39jp6Gj3wzOL4vmDRCeFqPVoyuTHXcvwkQZIY3cuPvb+i8N6XsTCs3ltOjCYQFw5TIu9ptMEbwYA7+daU02J1HtNpBpMJ347WvIhOMpcbZ5ZACQUoFI4CrV9RYy0xTxEkMGAOGf3JLwa0IjULoTDDsFHifk1VgouQeD2223FgAHJXd/dRZ1yKtR9cnB+LcWAJXBK7VXQ15NqSPfG8GR3FoA8eHkFnlDT2XIqzV0nyWdiQ1LvcUmhAmKUh4dmrYaus+EVg8Ak61RHvYoCbEwaXj6cPOAx7CZbC2n7MpqQtsBDBQRSBDJuAdkK2akrTra+P6JGzuhGLATeEXjuwuyXwl2bbjdaNWSeLh/PhIMANxirdlp/eUjwqJzn3O87WEgGCtzXknBaiBwOy+s0Zp7fmrbnystzhDfGUT/S1P//bUPSScDljVMmn+3IQxdpvJV9q5LfttPMdzi7Z089vbKZZCbQfvPFO6ShqfRWR9M7h+VS/pNKs9aQv7cXXuHxYVc0pv7TV8/PlR6JFKGpc7AxpQgkrHuafpO0zdPxFiIxbmbnI2J7ZVLL3edDLh+U1/NO2cXk6SHMVu+PpSKzItvHVlru+76ZRMRy9lTNqJx7ga3vb/FcmYz3nzcNUGYwpv/5e6LGy90uChqnrRkRtrTEoHMS9/XpDx2/d9nWvYQlKoSjAcq4xEAgLf/DNvvYrwJhdyZ2xkY9bcPwvLjJuvFT5xf2Hf+sSelcMtpD/NNFuakRU+KEaRwMYEFNwHDua4+D5Uk4a1xBJHn2cmfBKwnaTmxra7MhZUTyZn+pjfpHRdBaFxVa+90/IJrvbg7LmcpVMNAJN3Nor5aeNGx2Gh+0pMF79GRnoYP2HG89bQLa/ZiJlfoW5cIO/8plzq0CnvfjaBC0OCAemB14W6oKGjOD6ABu66dsLraJFhygIYZmjiZgaCA2XFjT4OYnxxck5DBnDJq0Sz5OjplNG0Tsrh/fmWGBSrzUTaTFw2xaMDx+zMTp42XFtcojxA02qMZ4rtK0tf46b6ECgBBh/iplskXBwq4N/MoxgMzWDr+zVKj4peO8lplBeQpyNBUZ5VLptwR/0AcvXQRNAAkIhGMmzGwhXblLxAi/dlbdz3DZnSpKyLxZnGTcM/oFfCy2S0QefSWXsgPQPoF7CgIrByUP0wmFkgDGA+Jybarahyxpe5TTD7HYas+BkxwSc/io0MSnGslhC0NdZuHlYlZGXNubvBla/UHPtNFy0nbla9cvpBWCv7AuC0jMADYdSRylMulf3rHcm4bw05qXxMguunwWqelMTAOO28l43YNWlQC0pPxwKPARgfDEZY2CxFnMBEWxHvbtUMO6x8sD6a9isnn/n8BcFhI0w+mo88zbAH+xcuetJaVt5xxGweT/r/XYZvNx/8MnuCDS8dy7v4LOqqIcXtHEACc5o43n7RdPYhDRaZzdHOZ3CgIU9jo6UCtwfoZt338T4ABAOAlLGLf40EKAAAAAElFTkSuQmCC",
    "displayName": "tradetracker-com",
    "id": "github.com_tradetracker-com"
  },
  "containerContexts": [
    "WEB"
  ]
}


___TEMPLATE_PARAMETERS___

[
  {
    "help": "Please select whether this tag should track sale events (retail orders and transactions), or if it should track lead events. Leads can be any custom visitor actions such as newsletter signups or demo requests.",
    "macrosInSelect": false,
    "selectItems": [
      {
        "displayValue": "Sales Tag",
        "value": "sale"
      },
      {
        "displayValue": "Leads Tag",
        "value": "lead"
      },
      {
        "value": "multi",
        "displayValue": "Multi Product Group Tag"
      }
    ],
    "displayName": "Tag Type",
    "simpleValueType": true,
    "name": "tagType",
    "type": "SELECT"
  },
  {
    "help": "Please enter your TradeTracker.com Campaign ID, or a variable that will return this value. If you run multiple campaigns please ensure it is the correct Id.\u003c/br\u003e\u003c/br\u003eIf you\u0027re unsure of what number to use, please  check in your Advertiser Dashboard or contact your Account Manager for assistance.",
    "displayName": "Campaign ID",
    "simpleValueType": true,
    "name": "campaignID",
    "type": "TEXT"
  },
  {
    "help": "Please enter your TradeTracker.com Product ID, or a variable that contains this value.\u003c/br\u003e\u003c/br\u003e If you\u0027re unsure about what number to use, please check in your Advertiser Dashboard or contact your Account Manager for assistance.\u003c/br\u003e\u003c/br\u003e \u003cem\u003ePlease note that this tag configuration cannot support multi-product group campaigns at this time.\u003c/em\u003e",
    "displayName": "Product ID",
    "simpleValueType": true,
    "name": "productID",
    "type": "TEXT"
  },
  {
    "help": "Please select the dataLayer variable for your Transaction or Order Id.\u003c/br\u003e\u003c/br\u003eFor the Sales tag this should be the same Id that you use to track sales internally, and it should be unique for every transaction.\u003c/br\u003e\u003c/br\u003eFor the Leads tag the Transaction Id can be any number you choose but also must be unique for each event.",
    "displayName": "Transaction ID",
    "simpleValueType": true,
    "name": "orderID",
    "type": "TEXT"
  },
  {
    "help": "Please select the dataLayer variable for the Total Transaction (Order) Amount \u003cstrong\u003eexcluding any applicable tax\u003c/strong\u003e.\u003c/br\u003e\u003c/br\u003eThis should be formatted as a string currency amount, for example $1,234.56 should be formatted as \"1234.56\".",
    "enablingConditions": [
      {
        "paramName": "tagType",
        "type": "NOT_EQUALS",
        "paramValue": "lead"
      }
    ],
    "displayName": "Transaction Amount",
    "simpleValueType": true,
    "name": "orderAmount",
    "type": "TEXT"
  },
  {
    "type": "TEXT",
    "name": "currency",
    "displayName": "Currency",
    "simpleValueType": true,
    "help": "Please enter the 3 letter currency code (\"USD\", \"EUR\" etc) for the currency that transactions on your website will be made in.",
    "defaultValue": "EUR"
  },
  {
    "type": "TEXT",
    "name": "basketItems",
    "displayName": "Basket Items Array",
    "simpleValueType": true,
    "enablingConditions": [
      {
        "paramName": "tagType",
        "paramValue": "multi",
        "type": "EQUALS"
      }
    ],
    "help": "Please select the dataLayer variable for the Basket Items in a sale.\u003c/br\u003e\u003c/br\u003e This should be an array of product objects, please refer to our documentation if you\u0027re unsure of which variable to use, or how to create the required variable."
  },
  {
    "type": "SELECT",
    "name": "basketType",
    "displayName": "DataLayer Purchase Event Type",
    "macrosInSelect": false,
    "selectItems": [
      {
        "value": "EE",
        "displayValue": "Enhanced Ecommerce (Universal Analytics)"
      },
      {
        "value": "GA",
        "displayValue": "Google Analytics 4"
      }
    ],
    "simpleValueType": true,
    "defaultValue": "EE",
    "enablingConditions": [
      {
        "paramName": "tagType",
        "paramValue": "multi",
        "type": "EQUALS"
      }
    ],
    "help": "This option allows you to choose between the type of purchase event used in your dataLayer. The more common model is Google\u0027s Universal Analytics Enhanced Ecommerce model, however the Google Analytics 4 model is also supported."
  },
  {
    "type": "SIMPLE_TABLE",
    "name": "productIds",
    "displayName": "ProductGroup ID",
    "simpleTableColumns": [
      {
        "defaultValue": "",
        "displayName": "ProductGroup ID",
        "name": "pid",
        "type": "TEXT"
      },
      {
        "defaultValue": "",
        "displayName": "Category Keywords",
        "name": "categories",
        "type": "TEXT"
      }
    ],
    "newRowButtonText": "Add Product Group",
    "help": "Add additional Product Groups by entering a ProductGroup ID in the left column, and a comma-separated list of category keywords for product-categories that should be matched to that product-group. \u003c/br\u003e\u003c/br\u003e  \u003cem\u003e\u003cstrong\u003eExample:\u003c/strong\u003eYou have a product-group for glasses and contacts, you can enter \"glasses, contacts\" as the category keyword.\u003c/em\u003e\u003c/br\u003e\u003c/br\u003e  It is also possible to enter regular expressions as category keywords to make matching more precise. \u003c/br\u003e\u003c/br\u003e  If you need any help setting up the additional Product Group Ids, please refer to our documentation, or contact your Account Manager for assistance.",
    "enablingConditions": [
      {
        "paramName": "tagType",
        "paramValue": "multi",
        "type": "EQUALS"
      }
    ]
  },
  {
    "type": "GROUP",
    "name": "extraQueries",
    "displayName": "Additional Paramters (Optional)",
    "groupStyle": "ZIPPY_OPEN_ON_PARAM",
    "subParams": [
      {
        "type": "LABEL",
        "name": "queries label",
        "displayName": "Add extra information to your sales tracking",
        "enablingConditions": [
          {
            "paramName": "tagType",
            "paramValue": "sale",
            "type": "EQUALS"
          }
        ]
      },
      {
        "type": "TEXT",
        "name": "voucherCode",
        "displayName": "Voucher code",
        "simpleValueType": true,
        "help": "Please add a variable for the voucher code used on the checkout page of your webshop.\u003c/br\u003e\u003c/br\u003eVoucher codes should be formatted as a string, such as \"DISCOUNT10\".",
        "enablingConditions": [
          {
            "paramName": "tagType",
            "paramValue": "lead",
            "type": "NOT_EQUALS"
          }
        ]
      },
      {
        "type": "TEXT",
        "name": "descrMerchant",
        "displayName": "Merchant description",
        "simpleValueType": true,
        "help": "Please add a variable for the description for the order. You can use any order information you might want to see in your TradeTracker account such as product names or categories.\u003c/br\u003e\u003c/br\u003e If you\u0027re unsure of what value to use, please contact your account manager for advice.\u003c/br\u003e\u003c/br\u003e\u003cem\u003eThis description is visible only to you in your TradeTracker.com account for statistical and analytics purposes.\u003c/em\u003e",
        "enablingConditions": []
      },
      {
        "type": "TEXT",
        "name": "descrAffiliate",
        "displayName": "Affiliate description",
        "simpleValueType": true,
        "help": "Please add a variable for the description for the order. This description is normally the name or category of the products included in the order.\u003c/br\u003e\u003c/br\u003e If you\u0027re unsure of what value to use, please contact your account manager for advice.\u003c/br\u003e\u003c/br\u003e\u003cem\u003eThis description is visible for affiliates only, and  is used by our affiliates for campaign optimisation.\u003c/em\u003e",
        "enablingConditions": []
      },
      {
        "type": "TEXT",
        "name": "hostname",
        "displayName": "Tracking host",
        "simpleValueType": true,
        "help": "This field is optional. Please leave blank by default, unless instructed otherwise by your TradeTracker Account Manager"
      }
    ]
  }
]


___SANDBOXED_JS_FOR_WEB_TEMPLATE___

//// PERMISSIONS ////
const encodeUriComponent = require('encodeUriComponent');
const query              = require('queryPermission');
const sendPixel          = require('sendPixel');

//// HELPER FUNCTIONS ////

// Custom find function as it is missing in templates standard lib
const find = (array, func) => {
  for (let i = 0; i < array.length; i++) {
    if (func(array[i])) return array[i];
  }
  return null;
};

// Test productGroup keywords against product category
function mapPid(productGroups, category) {
  for (var pid in productGroups) {
    var keywords = productGroups[pid];
    for (var i = 0, len = keywords.length; i < len; i++) {
      if (category.search(keywords[i].trim().toLowerCase()) != -1) {
        return pid;
      }
    }
  }
  return productID;
}

// Map a basket item as an object with a productId and amount
function mapProducts(product) {
  if (basketType === "EE") {
    // Return basket values for "EE" type of basket
    return product.map(function (item) {
      var category = typeof item.category === 'string' ? item.category : item.category.join(">");
      return {
        'amount': item.price * item.quantity,
        'productID': mapPid(productGroups, category.toLowerCase())
      };
    });
  } else {
    // Return basket values for "GA" type of basket
    return product.map(function (item) {
      var category = [item.item_category, item.item_category2, item.item_category3, item.item_category4, item.item_category5].filter(function(item) {
	  return item != "";
      }).join(">");
      return {
        'amount': item.price * item.quantity,
        'productID': mapPid(productGroups, category.toLowerCase())
      };
    });
  }
}

//// TAG LOGIC ////

// Set values from tag config
const campaignID  = data.hasOwnProperty('campaignID') ? '' + data.campaignID : '';
const productID   = data.hasOwnProperty('productID') ? '' + data.productID : '';
const orderID     = data.hasOwnProperty('orderID') ? '' + data.orderID : '';
const orderAmount = data.hasOwnProperty('orderAmount') ? '' + data.orderAmount : '';
const currency    = data.hasOwnProperty('currency') ? '' + data.currency : '';
const voucher     = data.hasOwnProperty('voucherCode') ? '' + data.voucherCode : '';
const descrMerc   = data.hasOwnProperty('descrMerchant') ? '' + data.descrMerchant : '';
const descrAffil  = data.hasOwnProperty('descrAffiliate') ? '' + data.descrAffiliate : '';
const productIds  = data.hasOwnProperty('productIds') ? data.productIds : [];
const basketItems = data.hasOwnProperty('basketItems') ? data.basketItems : [];
const basketType  = data.hasOwnProperty('basketType') ? data.basketType : [];

// Set tracking host
let domain = '';
let path   = '';
if (data.hasOwnProperty('hostname') && data.hostname !== undefined) {
  domain = data.hostname;
  path   = data.tagType === 'lead' ? 'l' : 's';
} else {
  domain = data.tagType === 'lead' ? 'tl.tradetracker.net' : 'ts.tradetracker.net';
}

// IF multi-product-group AND vars are set correctly
if(data.tagType == 'multi' && productIds.length > 0 && basketItems.length > 0) {
  
  // Map table of productIds and keywords to an object
  var productGroups = productIds.reduce(function (map, obj) {
    map[obj.pid] = obj.categories.split(',');
    return map;
  }, {});
  
  // Map basket items to productIds and sum totals if multiple items for one productId
  var basket = mapProducts(basketItems).reduce(function (bskt, item) {
    let found = find(bskt, x => x.productID === item.productID);
    if (found) {
      found.amount += item.amount;
    }
    else {
      bskt.push({ productID: item.productID, amount: item.amount });
    }
    return bskt;
  }, []);
  
}

let imgUrl  = '';
if (data.tagType === 'multi' && basket !== undefined && productGroups !== undefined) {
  // Loop over basket for multi-product-group tag
  for (let i = 0; i < basket.length; i++) {
    let imgUrl = 'https://' + domain + '/' + path;
    imgUrl += '?cid=' + encodeUriComponent(campaignID); 
    imgUrl += '&pid='  + encodeUriComponent(basket[i].productID);
    imgUrl += '&tid='  + encodeUriComponent(orderID);
    imgUrl += '&descrMerchant='  + encodeUriComponent(descrMerc);
    imgUrl += '&descrAffiliate=' + encodeUriComponent(descrAffil);
    imgUrl += '&tam='   + encodeUriComponent(basket[i].amount.toString());
    imgUrl += '&data=&event=sales&qty=1';
    imgUrl += '&currency=' + encodeUriComponent(currency);
    imgUrl += '&vc=' + encodeUriComponent(voucher);
    sendPixel(imgUrl, null, data.gtmOnFailure);
  }
  data.gtmOnSuccess();
} else {
  // ELSE Construct for regular sales/lead tag
  imgUrl += 'https://' + domain + '/' + path;
  imgUrl += '?cid=' + encodeUriComponent(campaignID);
  imgUrl += '&pid='  + encodeUriComponent(productID);
  imgUrl += '&tid='  + encodeUriComponent(orderID);
  imgUrl += '&descrMerchant='  + encodeUriComponent(descrMerc);
  imgUrl += '&descrAffiliate=' + encodeUriComponent(descrAffil);
  if (data.tagType !== 'lead') {
    // add sales only queries
    imgUrl += '&tam=' + encodeUriComponent(orderAmount);
    imgUrl += '&currency=' + encodeUriComponent(currency);
    imgUrl += '&vc=' + encodeUriComponent(voucher);
    imgUrl += '&event=sales&qty=1&data=';
  } else {
    // add lead query
    imgUrl += '&event=lead';
  }  
  
  // pixel success callback
  if (query('send_pixel', imgUrl)) {
    sendPixel(imgUrl, data.gtmOnSuccess, data.gtmOnFailure);
  }
}


___WEB_PERMISSIONS___

[
  {
    "instance": {
      "key": {
        "publicId": "send_pixel",
        "versionId": "1"
      },
      "param": [
        {
          "key": "allowedUrls",
          "value": {
            "type": 1,
            "string": "any"
          }
        }
      ]
    },
    "clientAnnotations": {
      "isEditedByUser": true
    },
    "isRequired": true
  }
]


___TESTS___

scenarios: []


___NOTES___

Created on 29/08/2019, 16:10:24


